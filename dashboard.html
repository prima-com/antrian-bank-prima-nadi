<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dashboard Operator Ultimate Core</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body{
font-family:Arial;
background:#0e2f5a;
color:white;
text-align:center;
margin:0;
padding:20px;
}
button{
padding:10px 15px;
margin:5px;
font-size:14px;
border:none;
border-radius:6px;
background:#FFD700;
cursor:pointer;
}
#statsBox{
margin-top:20px;
font-size:18px;
}
</style>
</head>
<body>

<h1>DASHBOARD OPERATOR</h1>

<div>
<button onclick="panggil('loket1')">Panggil Loket 1</button>
<button onclick="selesai('loket1')">Selesai Loket 1</button><br>

<button onclick="panggil('loket2')">Panggil Loket 2</button>
<button onclick="selesai('loket2')">Selesai Loket 2</button><br>

<button onclick="panggil('loket3')">Panggil Loket 3</button>
<button onclick="selesai('loket3')">Selesai Loket 3</button><br>

<button onclick="panggil('loket4')">Panggil Loket 4</button>
<button onclick="selesai('loket4')">Selesai Loket 4</button>
</div>

<h2>STATISTIK</h2>
<div id="statsBox"></div>

<script>

var firebaseConfig = {
apiKey:"AIzaSyB7f2r5KbTkk-14bc5cXNHEVlV5J1WfMf8",
authDomain:"antrian-bank-prima-nadi.firebaseapp.com",
databaseURL:"https://antrian-bank-prima-nadi-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"antrian-bank-prima-nadi"
};

firebase.initializeApp(firebaseConfig);
var db=firebase.database();

let busyLoket={};
let serviceStartTime={};
let lastNomor={};

function panggil(loket){

if(busyLoket[loket]) return;
busyLoket[loket]=true;

let prefix=(loket==="loket1"||loket==="loket2")?"A":"B";

db.ref("queue/"+prefix)
.orderByChild("status")
.equalTo("waiting")
.limitToFirst(1)
.once("value",snap=>{

if(!snap.exists()){
alert("Tidak ada antrian");
busyLoket[loket]=false;
return;
}

let key=Object.keys(snap.val())[0];
let data=snap.val()[key];

let now=Date.now();

lastNomor[loket]=data.nomor;
serviceStartTime[loket]=now;

db.ref("queue/"+prefix+"/"+key).update({
status:"serving",
calledTime:now,
loket:loket
});

db.ref("loket/"+loket).set({
nomor:data.nomor,
waktu:now
});

db.ref("stats/totalWaiting").transaction(v=>(v||1)-1);
db.ref("stats/totalCalled").transaction(v=>(v||0)+1);

let today=new Date().toISOString().slice(0,10);
db.ref("history/"+today).push({
nomor:data.nomor,
loket:loket,
waktu:now
});

setTimeout(()=>{busyLoket[loket]=false;},1500);

});
}

function selesai(loket){

if(!serviceStartTime[loket]) return;

let duration=Date.now()-serviceStartTime[loket];

db.ref("performance/"+loket+"/totalServed").transaction(v=>(v||0)+1);
db.ref("performance/"+loket+"/totalDuration").transaction(v=>(v||0)+duration);

serviceStartTime[loket]=null;

updateAverage();
}

function updateAverage(){

db.ref("performance").once("value",snap=>{
let perf=snap.val();
if(!perf) return;

let totalDur=0;
let totalSrv=0;

Object.values(perf).forEach(l=>{
totalDur+=l.totalDuration||0;
totalSrv+=l.totalServed||0;
});

if(totalSrv>0){
db.ref("stats/avgServiceTime").set(totalDur/totalSrv);
}
});
}

// STATISTIK LIVE
db.ref("stats").on("value",snap=>{
let s=snap.val();
if(!s) return;

document.getElementById("statsBox").innerHTML=
"Total Antrian: "+(s.totalToday||0)+"<br>"+
"Sudah Dipanggil: "+(s.totalCalled||0)+"<br>"+
"Sisa Menunggu: "+(s.totalWaiting||0);
});

</script>
</body>
</html>













